{% extends 'base.html' %}
{% load static %}

{% block title %}Discover Talents{% endblock %}

{% block style %}
    <link rel="stylesheet" href="{% static 'discover.css' %}" />
{% endblock %}

{% block content %}
<div class="container">
    <div class="discover-header">
        <h2>Discover the Next Generation of Football Stars</h2>
        <p>Browse profiles from talented players across East Africa.</p>
        
        <div class="search-container">
            <input type="text" id="live-search-input" class="search-input" placeholder="Type to filter players in the table...">
        </div>
    </div>

    <div class="table-container">
        <table class="player-table">
            <thead>
                <tr>
                    <th data-column="name" class="sortable">Player Name <span></span></th>
                    <th data-column="position" class="sortable">Position <span></span></th>
                    <th data-column="country" class="sortable">Country <span></span></th>
                    <th data-column="age" class="sortable">Age <span></span></th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="player-table-body">
                {% for player in players %}
                    <tr>
                        <td>{{ player.user.get_full_name|default:player.user.username }}</td>
                        <td>{{ player.position }}</td>
                        <td>{{ player.country }}</td>
                        <td>{{ player.age|default:'N/A' }}</td>
                        <td>
                            <a href="{% url 'player_detail' player.pk %}" class="btn-view">View Profile</a>
                        </td>
                    </tr>
                {% empty %}
                    <tr class="empty-state-row">
                        <td colspan="5">No players found in the database.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- LIVE SEARCH FUNCTIONALITY ---
        const searchInput = document.getElementById('live-search-input');
        const tableBody = document.getElementById('player-table-body');
        const tableRows = tableBody.getElementsByTagName('tr');

        searchInput.addEventListener('keyup', function() {
            const searchTerm = searchInput.value.toLowerCase();

            for (let i = 0; i < tableRows.length; i++) {
                // Ignore the empty state row
                if (tableRows[i].classList.contains('empty-state-row')) continue;

                const rowText = tableRows[i].textContent.toLowerCase();
                if (rowText.includes(searchTerm)) {
                    tableRows[i].style.display = '';
                } else {
                    tableRows[i].style.display = 'none';
                }
            }
        });


        // --- TABLE SORTING FUNCTIONALITY ---
        const sortableHeaders = document.querySelectorAll('.player-table .sortable');
        
        sortableHeaders.forEach(header => {
            header.addEventListener('click', function() {
                const column = header.dataset.column;
                const currentOrder = header.getAttribute('data-order') || 'desc';
                const newOrder = currentOrder === 'desc' ? 'asc' : 'desc';

                // Reset other headers
                sortableHeaders.forEach(h => {
                    h.classList.remove('asc', 'desc');
                    h.removeAttribute('data-order');
                });

                // Set new order on clicked header
                header.classList.add(newOrder);
                header.setAttribute('data-order', newOrder);

                // Perform the sort
                sortTable(header.cellIndex, newOrder);
            });
        });

        function sortTable(columnIndex, order) {
            const rowsArray = Array.from(tableRows);
            
            const sortedRows = rowsArray.sort((a, b) => {
                // Ignore the empty state row during sort
                if (a.classList.contains('empty-state-row') || b.classList.contains('empty-state-row')) return 0;
                
                const aText = a.cells[columnIndex].textContent.trim();
                const bText = b.cells[columnIndex].textContent.trim();

                // Check if the content is numeric for proper sorting
                const aVal = isNaN(parseFloat(aText)) ? aText.toLowerCase() : parseFloat(aText);
                const bVal = isNaN(parseFloat(bText)) ? bText.toLowerCase() : parseFloat(bText);

                if (aVal < bVal) {
                    return order === 'asc' ? -1 : 1;
                }
                if (aVal > bVal) {
                    return order === 'asc' ? 1 : -1;
                }
                return 0;
            });
            
            // Re-append the sorted rows to the table body
            sortedRows.forEach(row => tableBody.appendChild(row));
        }
    });
</script>
{% endblock %}