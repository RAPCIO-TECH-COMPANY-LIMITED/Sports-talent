{% extends 'base.html' %}
{% load static %}

{% block title %}Talent Database | EA Sports{% endblock %}

{% block style %}
<link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,700;0,900;1,900&display=swap" rel="stylesheet">
<style>
    /* --- SKY SPORTS THEME --- */
    :root {
        --sky-blue: #06163F;
        --sky-blue-light: #1a2c5e;
        --sky-red: #CD1316;
        --sky-red-hover: #a00f11;
        --sky-gray: #f4f4f4;
        --text-dark: #111;
        --white: #ffffff;
    }

    body {
        background-color: #eee;
        font-family: 'Roboto', sans-serif;
    }

    .discover-container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 0 20px;
    }

    /* --- HEADER SECTION --- */
    .page-header {
        margin-bottom: 30px;
        border-left: 6px solid var(--sky-red);
        padding: 20px;
        background: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .page-header h2 {
        margin: 0;
        font-size: 2.5rem;
        font-weight: 900;
        text-transform: uppercase;
        color: var(--sky-blue);
        font-style: italic;
        line-height: 1;
    }

    /* --- FILTERS PANEL --- */
    .filter-section {
        background-color: var(--sky-blue);
        padding: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: flex-end;
        border-bottom: 4px solid var(--sky-red);
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-width: 200px;
    }

    .filter-group label {
        color: #aaa;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        margin-bottom: 5px;
    }

    .filter-control {
        padding: 10px;
        border: none;
        border-radius: 0;
        font-weight: 700;
        height: 45px;
    }

    .search-input {
        flex: 2;
        min-width: 300px;
    }

    .live-badge {
        background: var(--sky-red);
        color: white;
        padding: 5px 10px;
        font-weight: bold;
        font-size: 0.8rem;
        text-transform: uppercase;
        height: fit-content;
        align-self: center;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }

    /* --- DATA TABLE --- */
    .table-container {
        background: white;
        overflow-x: auto;
        box-shadow: 0 10px 20px rgba(0,0,0,0.05);
    }

    .player-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 900px;
    }

    .player-table thead {
        background-color: #e0e0e0;
    }

    .player-table th {
        text-align: left;
        padding: 15px 20px;
        font-size: 0.85rem;
        font-weight: 900;
        text-transform: uppercase;
        color: var(--sky-blue);
        border-bottom: 2px solid #ccc;
        cursor: pointer;
    }

    .player-table td {
        padding: 15px 20px;
        border-bottom: 1px solid #eee;
        color: #333;
        font-size: 0.95rem;
    }

    .player-name-cell {
        font-weight: 700;
        color: var(--sky-blue);
        text-transform: uppercase;
    }

    .affiliation-badge {
        font-size: 0.8rem;
        padding: 4px 8px;
        background: #f0f0f0;
        border-radius: 3px;
        color: #555;
        font-weight: 700;
    }

    .free-agent {
        color: var(--sky-red);
        font-style: italic;
        font-weight: normal;
        background: #fff0f0;
    }

    .btn-view {
        display: inline-block;
        padding: 8px 15px;
        background-color: white;
        color: var(--sky-blue);
        border: 2px solid var(--sky-blue);
        text-decoration: none;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.75rem;
        transition: all 0.2s;
    }

    .btn-view:hover {
        background-color: var(--sky-blue);
        color: white;
    }

    @media (max-width: 768px) {
        .filter-section { flex-direction: column; align-items: stretch; }
        .filter-group { min-width: 100%; }
    }
</style>
{% endblock %}

{% block content %}
<div class="discover-container">

    <div class="page-header">
        <h2>Talent Database</h2>
        <p>Live scouting data from East Africa's top emerging players.</p>
    </div>

    <!-- Enhanced Filter Section -->
    <div class="filter-section">
        <div class="filter-group search-input">
            <label for="search-filter">Keyword Search</label>
            <input type="text" id="search-filter" class="filter-control" placeholder="Search Name, Country...">
        </div>

        <div class="filter-group">
            <label for="position-filter">Position</label>
            <select id="position-filter" class="filter-control">
                <option value="">All Positions</option>
                {% for pos in positions %}
                <option value="{{ pos }}">{{ pos }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label for="affiliation-filter">Club / Academy</label>
            <select id="affiliation-filter" class="filter-control">
                <option value="">All Affiliations</option>
                <option value="Free Agent">Free Agents</option>
                {% for aff in affiliations %}
                <option value="{{ aff }}">{{ aff }}</option>
                {% endfor %}
            </select>
        </div>

        <span class="live-badge">LIVE DATA</span>
    </div>

    <div class="table-container">
        <table class="player-table">
            <thead>
            <tr>
                <th data-column="name" class="sortable">Player Name</th>
                <th data-column="position" class="sortable">Position</th>
                <th data-column="affiliation" class="sortable">Club / Academy</th>
                <th data-column="country" class="sortable">Country</th>
                <th data-column="age" class="sortable">Age</th>
                <th>Action</th>
            </tr>
            </thead>
            <tbody id="player-table-body">
            {% for player in players %}
            <tr class="player-row"
                data-position="{{ player.position }}"
                data-affiliation="{% if player.club %}{{ player.club.club_name }}{% elif player.academy %}{{ player.academy.academy_name }}{% else %}Free Agent{% endif %}">
                <td class="player-name-cell">{{ player.user.get_full_name|default:player.user.username }}</td>
                <td><strong>{{ player.position }}</strong></td>
                <td>
                    {% if player.club %}
                    <span class="affiliation-badge">{{ player.club.club_name }}</span>
                    {% elif player.academy %}
                    <span class="affiliation-badge">{{ player.academy.academy_name }}</span>
                    {% else %}
                    <span class="affiliation-badge free-agent">Free Agent</span>
                    {% endif %}
                </td>
                <td>{{ player.country }}</td>
                <td>{{ player.age|default:'-' }}</td>
                <td>
                    <a href="{% url 'player_detail' player.pk %}" class="btn-view">View Profile &rarr;</a>
                </td>
            </tr>
            {% empty %}
            <tr class="empty-state-row">
                <td colspan="6" style="text-align: center; padding: 50px;">No players match your current criteria.</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('search-filter');
        const positionFilter = document.getElementById('position-filter');
        const affiliationFilter = document.getElementById('affiliation-filter');
        const tableBody = document.getElementById('player-table-body');
        const rows = Array.from(tableBody.querySelectorAll('.player-row'));

        function filterPlayers() {
            const searchTerm = searchInput.value.toLowerCase();
            const posTerm = positionFilter.value;
            const affTerm = affiliationFilter.value;

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const pos = row.dataset.position;
                const aff = row.dataset.affiliation;

                const matchesSearch = text.includes(searchTerm);
                const matchesPos = posTerm === "" || pos === posTerm;
                const matchesAff = affTerm === "" || aff === affTerm;

                if (matchesSearch && matchesPos && matchesAff) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Add event listeners for all filters
        searchInput.addEventListener('input', filterPlayers);
        positionFilter.addEventListener('change', filterPlayers);
        affiliationFilter.addEventListener('change', filterPlayers);

        // Sorting logic (simplified from your original)
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', () => {
                const column = header.cellIndex;
                const isAsc = header.classList.contains('asc');

                rows.sort((a, b) => {
                    const aVal = a.cells[column].innerText.toLowerCase();
                    const bVal = b.cells[column].innerText.toLowerCase();
                    return isAsc ? (aVal < bVal ? 1 : -1) : (aVal > bVal ? 1 : -1);
                });

                document.querySelectorAll('.sortable').forEach(h => h.classList.remove('asc', 'desc'));
                header.classList.toggle('asc', !isAsc);
                header.classList.toggle('desc', isAsc);

                rows.forEach(row => tableBody.appendChild(row));
            });
        });
    });
</script>
{% endblock %}